<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.2.0"
           xsi:schemaLocation="
       http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
       http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.0.0 http://aries.apache.org/schemas/blueprint-cm/blueprint-cm-1.0.0.xsd
       http://camel.apache.org/schema/blueprint http://camel.apache.org/schema/blueprint/camel-blueprint.xsd">
    
    <cm:property-placeholder persistent-id="xatest" update-strategy="reload">
        <cm:default-properties>
            <cm:property name="oracle.db.jdbcURL" value="jdbc:oracle:thin:@localhost:1521:test" />
            <cm:property name="oracle.db.username" value="testaq" />
            <cm:property name="oracle.db.password" value="test1234" />
            <cm:property name="oracle.db.testQueue" value="XA_TEST_Q" />
            <cm:property name="activemq.brokerURL" value="tcp://192.168.1.10:61616" />
            <cm:property name="activemq.username" value="test" />
            <cm:property name="activemq.password" value="test1234" />
            <cm:property name="activemq.testQueue" value="TestQueue" />
            <cm:property name="basic.test.sendingPeriod" value="10" />
            <cm:property name="basic.test.repeatCount" value="100" />
        </cm:default-properties>
    </cm:property-placeholder>
    
    <reference id="platformTransactionManager"
               interface="org.springframework.transaction.PlatformTransactionManager" />
    <reference id="transactionManager"
               interface="javax.transaction.TransactionManager" />
    
    <bean id="txRequired" class="org.apache.camel.spring.spi.SpringTransactionPolicy">
        <property name="transactionManager" ref="platformTransactionManager" />
        <property name="propagationBehaviorName" value="PROPAGATION_REQUIRED" />
    </bean>
               
    <!-- Oracle beans -->
    <bean id="oracleAqConnectionFactory" class="oracle.jms.AQjmsXAConnectionFactory">
        <property name="jdbcURL" value="${oracle.db.jdbcURL}"/>
        <property name="username" value="${oracle.db.username}" />
        <property name="password" value="${oracle.db.password}" />	 
    </bean>
    
    <bean id="oracleAqPooledConnectionFactory" class="org.apache.activemq.jms.pool.JcaPooledConnectionFactory"
          init-method="start" destroy-method="stop">
        <property name="connectionFactory" ref="oracleAqConnectionFactory" />
        <property name="transactionManager" ref="transactionManager" />
        <property name="maxConnections" value="1" />
        <property name="name" value="oracleaq-test" />
    </bean>
    
    <bean id="oracleAqTxConfig" class="org.apache.camel.component.jms.JmsConfiguration">
        <property name="connectionFactory" ref="oracleAqPooledConnectionFactory" />
        <property name="transactionManager" ref="platformTransactionManager" />
        <property name="transacted" value="false" />
        <property name="maxConcurrentConsumers" value="1" />
        <property name="cacheLevelName" value="CACHE_NONE" />
    </bean>
    
    <bean id="oracleaq" class="org.apache.camel.component.jms.JmsComponent">
        <property name="configuration" ref="oracleAqTxConfig" />
    </bean>
    
    <bean id="oracleAQResourceManager"
          class="org.apache.activemq.pool.ActiveMQResourceManager"
          init-method="recoverResource"> 
        <property name="transactionManager" ref="transactionManager" />
        <property name="connectionFactory" ref="oracleAqConnectionFactory" />
        <property name="resourceName" value="oracleaq-test" /> 
    </bean>
    
    <!-- ActiveMQ beans -->
    <bean id="actimemqConnectionFactory" class="org.apache.activemq.ActiveMQXAConnectionFactory">
        <property name="brokerURL" value="${activemq.brokerURL}" />
        <property name="userName" value="${activemq.username}" />
        <property name="password" value="${activemq.password}" />
    </bean>

    <bean id="actimemqPooledConnectionFactory" class="org.apache.activemq.pool.JcaPooledConnectionFactory" init-method="start" destroy-method="stop">
        <property name="connectionFactory" ref="actimemqConnectionFactory" />
        <property name="transactionManager" ref="transactionManager" />
        <property name="maxConnections" value="1" />
        <property name="name" value="activemq-test" />        
    </bean>

    <bean id="activemqTxConfig" class="org.apache.camel.component.jms.JmsConfiguration">
        <property name="connectionFactory" ref="actimemqPooledConnectionFactory" />
        <property name="transacted" value="false" />
        <property name="transactionManager" ref="platformTransactionManager" />
        <property name="maxConcurrentConsumers" value="1" />
        <property name="cacheLevelName" value="CACHE_NONE" />
    </bean>
    
    <bean id="activemqResourceManager"
          class="org.apache.activemq.pool.ActiveMQResourceManager"
          init-method="recoverResource"> 
        <property name="transactionManager" ref="transactionManager" />
        <property name="connectionFactory" ref="actimemqConnectionFactory" />
        <property name="resourceName" value="activemq-test" /> 
    </bean>

    <bean id="amq" class="org.apache.activemq.camel.component.ActiveMQComponent">
        <property name="configuration" ref="activemqTxConfig" />
    </bean>
    
    <camelContext xmlns="http://camel.apache.org/schema/blueprint" id="oracleAqXaTestContext">        
        <route id="generatorTestRoute">
            <from uri="timer:messageGenerator?period={{basic.test.sendingPeriod}}&amp;repeatCount={{basic.test.repeatCount}}" />
            <setBody>
                <simple>Test message number ${date:now:HHmmssSSS}</simple>
            </setBody>  
            <transacted ref="txRequired" />
            <to uri="amq:queue:{{activemq.testQueue}}" />
            <to uri="oracleaq:queue:{{oracle.db.testQueue}}" />
        </route>
        
        <route id="consumerTestRoute">
            <from uri="oracleaq:queue:{{oracle.db.testQueue}}" />   
            <log message="Message received from ActiveMQ: ${body}" /> 
        </route>
    </camelContext>
</blueprint>
